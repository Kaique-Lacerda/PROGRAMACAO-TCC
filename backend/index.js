import express from 'express'; //funcionar API
import cors from 'cors'; //Permitir requisi√ß√µes de outras origens
import sqlite3 from 'sqlite3'; //Banco de dados 
import bcrypt from 'bcryptjs'; //criptografia de senhas
import jwt from 'jsonwebtoken'; //token para autentica√ß√£o

const app = express(); 
const db = new sqlite3.Database('./db.sqlite');
const SECRET = 'tcc_secret_key';

// üéØ Sistema de Logging Organizado
const log = (emoji, category, message, data = null) => {
  const timestamp = new Date().toLocaleTimeString();
  console.log(`${emoji} [${timestamp}] ${category}: ${message}`);
  if (data) console.log('   üì¶ Dados:', data);
};

// üîß Configura√ß√µes do Servidor
app.use(cors({
  origin: 'https://games-deliver-cow-hospitals.trycloudflare.com', // alterar sempre que iniciar novo sv
  credentials: true
}));

app.use(express.json()); // Permitir receber JSON no corpo das requisi√ß√µes

// üóÑÔ∏è Cria√ß√£o das Tabelas
const createTables = () => {
  db.run(`CREATE TABLE IF NOT EXISTS users ( 
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE,
    password TEXT
  )`);//cria tabela de usu√°rios caso n√£o exista
  
  db.run(`CREATE TABLE IF NOT EXISTS musicas (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    nome TEXT,
    caminho TEXT,
    favorita BOOLEAN DEFAULT 0,
    pre_definida BOOLEAN DEFAULT 0,
    artista TEXT DEFAULT 'Desconhecido',
    duracao TEXT DEFAULT '0:00',
    FOREIGN KEY(user_id) REFERENCES users(id)
  )`);//cria tabela de m√∫sicas caso n√£o exista
  
  log('üíæ', 'DATABASE', 'Tabelas criadas/verificadas com sucesso');
};
createTables();

// üéµ Sistema de M√∫sicas Pr√©-definidas
const atualizarMusicasPreDefinidas = () => {
  const musicasPreDefinidas = [
    { 
      nome: 'Bathroom', 
      artista: 'Montell Fish', 
      duracao: '3:28', 
      pre_definida: 1,
      caminho: 'local_bathroom'
    },
    { 
      nome: 'Eu Vou Te Comer Sorrindo', 
      artista: 'MC GUTO VGS', 
      duracao: '2:17', 
      pre_definida: 1,
      caminho: 'local_eu_vou_te_comer_sorrindo'
    },
    { 
      nome: 'K.O', 
      artista: 'Pabllo Vittar', 
      duracao: '2:35', 
      pre_definida: 1,
      caminho: 'local_k_o'
    },
    { 
      nome: 'Rainbow', 
      artista: 'All Night Long', 
      duracao: '4:12', 
      pre_definida: 1,
      caminho: 'local_rainbow_all_night_long'
    },
    { 
      nome: 'Shut Up and Listen', 
      artista: 'Nicholas Bonnin', 
      duracao: '3:15', 
      pre_definida: 1,
      caminho: 'local_shut_up_and_listen'
    },
    { 
      nome: 'Sol Loiro', 
      artista: 'Armandinho', 
      duracao: '2:45', 
      pre_definida: 1,
      caminho: 'local_sol_loiro'
    },
    { 
      nome: 'Flamingos', 
      artista: 'Baco Exu do Blues', 
      duracao: '3:50', 
      pre_definida: 1,
      caminho: 'local_flamingos'
    }
  ];

  log('üîÑ', 'M√öSICAS', `Processando ${musicasPreDefinidas.length} m√∫sica(s) pr√©-definida(s)`);

  musicasPreDefinidas.forEach(musica => {
    db.get(
      'SELECT id FROM musicas WHERE nome = ? AND pre_definida = 1',
      [musica.nome],
      (err, row) => {
        if (err) {
          log('‚ùå', 'M√öSICAS', `Erro ao verificar m√∫sica: ${musica.nome}`, err);
          return;
        }
        
        if (!row) {
          db.run(
            'INSERT INTO musicas (user_id, nome, caminho, artista, duracao, pre_definida) VALUES (NULL, ?, ?, ?, ?, ?)',
            [musica.nome, musica.caminho, musica.artista, musica.duracao, musica.pre_definida],
            function(err) {
              if (err) {
                log('‚ùå', 'M√öSICAS', `Erro ao adicionar: ${musica.nome}`, err);
              } else {
                log('‚úÖ', 'M√öSICAS', `Adicionada: ${musica.nome} (ID: ${this.lastID})`);
              }
            }
          );
        } else {
          log('‚ö†Ô∏è', 'M√öSICAS', `J√° existe: ${musica.nome} (ID: ${row.id})`);
        }
      }
    );
  });
};

// ‚è∞ Inicializa√ß√£o das M√∫sicas
setTimeout(atualizarMusicasPreDefinidas, 1000);

// üåê Rotas da API

// Rota de Health Check
app.get('/', (req, res) => {
  log('üåê', 'API', 'Health check recebido');
  res.json({ 
    message: 'API funcionando!',
    timestamp: new Date().toISOString()
  });
});

// Cadastro de Usu√°rio
app.post('/register', (req, res) => {
  const { username, password } = req.body;
  const hash = bcrypt.hashSync(password, 8);
  
  log('üë§', 'AUTH', `Tentativa de registro: ${username}`);
  
  db.run(
    'INSERT INTO users (username, password) VALUES (?, ?)',
    [username, hash],
    function (err) {
      if (err) {
        log('‚ùå', 'AUTH', `Usu√°rio j√° existe: ${username}`);
        return res.status(400).json({ error: 'Usu√°rio j√° existe.' });
      }
      
      log('‚úÖ', 'AUTH', `Usu√°rio registrado: ${username} (ID: ${this.lastID})`);
      res.json({ id: this.lastID, username });
    }
  );
});

// Login de Usu√°rio
app.post('/login', (req, res) => {
  const { username, password } = req.body;
  
  log('üîê', 'AUTH', `Tentativa de login: ${username}`);
  
  db.get('SELECT * FROM users WHERE username = ?', [username], (err, user) => {
    if (!user) {
      log('‚ùå', 'AUTH', `Usu√°rio n√£o encontrado: ${username}`);
      return res.status(400).json({ error: 'Usu√°rio n√£o encontrado.' });
    }
    
    if (!bcrypt.compareSync(password, user.password)) {
      log('‚ùå', 'AUTH', `Senha incorreta para: ${username}`);
      return res.status(401).json({ error: 'Senha incorreta.' });
    }
    
    const token = jwt.sign({ id: user.id, username: user.username }, SECRET, { expiresIn: '1d' });
    log('‚úÖ', 'AUTH', `Login bem-sucedido: ${username}`);
    res.json({ token });
  });
});

// üîí Middleware de Autentica√ß√£o
function auth(req, res, next) {
  const token = req.headers['authorization'];
  
  if (!token) {
    log('‚ùå', 'AUTH', 'Token n√£o fornecido');
    return res.status(401).json({ error: 'Token n√£o fornecido.' });
  }
  
  try {
    req.user = jwt.verify(token, SECRET);
    log('üîê', 'AUTH', `Token v√°lido para: ${req.user.username}`);
    next();
  } catch (error) {
    log('‚ùå', 'AUTH', 'Token inv√°lido', error);
    res.status(401).json({ error: 'Token inv√°lido.' });
  }
}

// üéµ Rotas de M√∫sica

// Buscar todas as m√∫sicas do usu√°rio
app.get('/musicas', auth, (req, res) => {
  log('üéµ', 'M√öSICAS', `Buscando m√∫sicas para: ${req.user.username}`);
  
  const query = `
    SELECT * FROM musicas 
    WHERE user_id IS NULL OR user_id = ?
    ORDER BY pre_definida DESC, favorita DESC, nome ASC
  `;
  
  db.all(query, [req.user.id], (err, rows) => {
    if (err) {
      log('‚ùå', 'M√öSICAS', 'Erro ao buscar m√∫sicas', err);
      return res.status(500).json({ error: 'Erro ao buscar m√∫sicas.' });
    }
    
    const musicasOrganizadas = {
      preDefinidas: rows.filter(m => m.pre_definida === 1),
      userMusicas: rows.filter(m => m.pre_definida === 0),
      favoritas: rows.filter(m => m.favorita === 1)
    };
    
    log('‚úÖ', 'M√öSICAS', 
      `Encontradas: ${musicasOrganizadas.preDefinidas.length} pr√©-definidas, ` +
      `${musicasOrganizadas.userMusicas.length} do usu√°rio, ` +
      `${musicasOrganizadas.favoritas.length} favoritas`
    );
    
    res.json(musicasOrganizadas);
  });
});

// Adicionar m√∫sica do usu√°rio
app.post('/musicas', auth, (req, res) => {
  const { nome, caminho, artista = 'Desconhecido', duracao = '0:00' } = req.body;
  
  log('üéµ', 'M√öSICAS', `Adicionando m√∫sica: ${nome}`, { artista, duracao });
  
  db.run(
    'INSERT INTO musicas (user_id, nome, caminho, artista, duracao, pre_definida) VALUES (?, ?, ?, ?, ?, 0)',
    [req.user.id, nome, caminho, artista, duracao],
    function (err) {
      if (err) {
        log('‚ùå', 'M√öSICAS', `Erro ao salvar: ${nome}`, err);
        return res.status(500).json({ error: 'Erro ao salvar m√∫sica.' });
      }
      
      log('‚úÖ', 'M√öSICAS', `M√∫sica salva: ${nome} (ID: ${this.lastID})`);
      res.json({ 
        id: this.lastID, 
        nome, 
        caminho, 
        artista, 
        duracao,
        pre_definida: 0,
        favorita: 0
      });
    }
  );
});

// Toggle favorito
app.put('/musicas/:id/favorito', auth, (req, res) => {
  const { id } = req.params;
  
  log('‚≠ê', 'M√öSICAS', `Alternando favorito para m√∫sica ID: ${id}`);
  
  db.run(
    'UPDATE musicas SET favorita = NOT favorita WHERE id = ? AND user_id = ?',
    [id, req.user.id],
    function (err) {
      if (err) {
        log('‚ùå', 'M√öSICAS', `Erro ao favoritar ID: ${id}`, err);
        return res.status(500).json({ error: 'Erro ao favoritar.' });
      }
      
      log('‚úÖ', 'M√öSICAS', `Favorito alternado para m√∫sica ID: ${id}`);
      res.json({ success: true });
    }
  );
});

// Deletar m√∫sica do usu√°rio
app.delete('/musicas/:id', auth, (req, res) => {
  const { id } = req.params;
  
  log('üóëÔ∏è', 'M√öSICAS', `Deletando m√∫sica ID: ${id}`);
  
  db.run(
    'DELETE FROM musicas WHERE id = ? AND user_id = ? AND pre_definida = 0',
    [id, req.user.id],
    function (err) {
      if (err) {
        log('‚ùå', 'M√öSICAS', `Erro ao deletar ID: ${id}`, err);
        return res.status(500).json({ error: 'Erro ao deletar m√∫sica.' });
      }
      
      if (this.changes === 0) {
        log('‚ö†Ô∏è', 'M√öSICAS', `M√∫sica n√£o encontrada ou √© pr√©-definida ID: ${id}`);
        return res.status(404).json({ error: 'M√∫sica n√£o encontrada.' });
      }
      
      log('‚úÖ', 'M√öSICAS', `M√∫sica deletada ID: ${id}`);
      res.json({ success: true });
    }
  );
});

// üë• Listar usu√°rios (apenas para desenvolvimento)
app.get('/users', (req, res) => {
  log('üë•', 'USERS', 'Listando todos os usu√°rios');
  
  db.all('SELECT id, username FROM users', [], (err, rows) => {
    if (err) {
      log('‚ùå', 'USERS', 'Erro ao buscar usu√°rios', err);
      return res.status(500).json({ error: 'Erro ao buscar usu√°rios.' });
    }
    
    log('‚úÖ', 'USERS', `Encontrados ${rows.length} usu√°rio(s)`);
    res.json(rows);
  });
});

// üîÑ For√ßar atualiza√ß√£o de m√∫sicas pr√©-definidas
app.post('/atualizar-musicas', (req, res) => {
  log('üîÑ', 'M√öSICAS', 'For√ßando atualiza√ß√£o de m√∫sicas pr√©-definidas');
  atualizarMusicasPreDefinidas();
  res.json({ message: 'Atualiza√ß√£o de m√∫sicas iniciada' });
});

// üöÄ Inicializa√ß√£o do Servidor
app.listen(3001, '0.0.0.0', () => {
  log('üöÄ', 'SERVER', 'API rodando na porta 3001');
  log('üéµ', 'SERVER', 'Sistema de m√∫sicas inteligente ativo');
  log('üîß', 'SERVER', 'Pronto para receber requisi√ß√µes');
});